<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>مساعد الذكاء الاصطناعي المتطور</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap');
    
    :root {
      --primary-color: #128c7e;
      --primary-dark: #075e54;
      --primary-light: #25d366;
      --user-message: #dcf8c6;
      --bot-message: #ffffff;
      --background: #f0f2f5;
      --text-primary: #3c4043;
      --text-secondary: #5f6368;
      --border-color: #dadce0;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.12);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Tajawal', sans-serif;
    }
    
    body {
      background: var(--background);
      color: var(--text-primary);
      direction: rtl;
      height: 100vh;
      overflow: hidden;
    }
    
    #app {
      max-width: 1000px;
      margin: 0 auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      background: white;
      position: relative;
    }
    
    /* الرأس المحسن */
    header {
      height: 70px;
      background: linear-gradient(to right, var(--primary-dark), var(--primary-color));
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 25px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .logo {
      width: 40px;
      height: 40px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--primary-dark);
    }
    
    .app-title h1 {
      font-size: 1.4rem;
      font-weight: 700;
    }
    
    .app-title p {
      font-size: 0.8rem;
      opacity: 0.9;
    }
    
    .header-actions {
      display: flex;
      gap: 15px;
    }
    
    .header-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      color: white;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .header-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }
    
    /* القائمة الجانبية المحسنة */
    #sidebar {
      position: fixed;
      top: 70px;
      right: 0;
      width: 300px;
      height: calc(100vh - 70px);
      background: white;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 90;
    }
    
    #sidebar.visible {
      transform: translateX(0);
    }
    
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .sidebar-header h2 {
      font-size: 1.3rem;
      color: var(--primary-dark);
    }
    
    .close-sidebar {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-secondary);
      cursor: pointer;
    }
    
    #new-chat-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 25px;
      padding: 10px 20px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 20px;
      width: 100%;
    }
    
    #new-chat-btn:hover {
      background: var(--primary-dark);
    }
    
    #chat-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    #chat-list li {
      padding: 12px 15px;
      background: white;
      margin-bottom: 8px;
      cursor: pointer;
      border-radius: 10px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid var(--border-color);
    }
    
    .chat-info {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }
    
    #chat-list li:hover {
      background: #f5f5f5;
    }
    
    #chat-list li.active {
      background: #e8f5e9;
      border-color: var(--primary-light);
      color: var(--primary-dark);
      font-weight: 500;
    }
    
    .chat-icon {
      color: var(--primary-color);
    }
    
    .delete-chat {
      background: none;
      border: none;
      color: #f44336;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.3s;
      padding: 5px;
    }
    
    .delete-chat:hover {
      opacity: 1;
    }
    
    /* منطقة المحادثة المحسنة */
    #chat-window {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow-y: auto;
      background-color: var(--background);
      background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23e0e0e0' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
    }
    
    .message {
      max-width: 85%;
      margin-bottom: 20px;
      padding: 15px 20px;
      border-radius: 18px;
      font-size: 16px;
      line-height: 1.5;
      position: relative;
      animation: fadeIn 0.3s ease;
      box-shadow: var(--shadow);
      transition: transform 0.2s ease;
    }
    
    .message:hover {
      transform: translateY(-2px);
    }
    
    .message.user {
      background: var(--user-message);
      align-self: flex-end;
      border-bottom-right-radius: 0;
    }
    
    .message.bot {
      background: var(--bot-message);
      align-self: flex-start;
      border-bottom-left-radius: 0;
      border: 1px solid var(--border-color);
    }
    
    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 5px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .message-sender {
      font-weight: 700;
      font-size: 0.9rem;
    }
    
    .message-time {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    
    .message-content {
      padding: 5px 0;
    }
    
    /* منطقة الإدخال المحسنة */
    #input-area {
      display: flex;
      align-items: center;
      padding: 15px;
      border-top: 1px solid var(--border-color);
      background-color: white;
      gap: 10px;
      position: relative;
    }
    
    #input-area .input-group {
      display: flex;
      flex: 1;
      background: #f5f5f5;
      border-radius: 25px;
      padding: 5px 15px;
      align-items: center;
    }
    
    #input-area input[type="text"] {
      flex: 1;
      padding: 12px 10px;
      border: none;
      background: transparent;
      font-size: 16px;
      outline: none;
      direction: rtl;
    }
    
    .input-actions {
      display: flex;
      gap: 5px;
    }
    
    .input-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      border-radius: 50%;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .input-btn:hover {
      background: #e0e0e0;
      color: var(--primary-color);
    }
    
    #send-btn {
      background: var(--primary-color);
      color: white;
    }
    
    #send-btn:hover {
      background: var(--primary-dark);
      transform: scale(1.05);
    }
    
    /* قائمة الاختيارات المحسنة */
    #dropdown {
      position: fixed;
      bottom: 85px;
      right: 30px;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      display: none;
      flex-direction: column;
      width: 220px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      z-index: 200;
      overflow: hidden;
    }
    
    #dropdown button {
      background: none;
      border: none;
      padding: 12px 20px;
      font-size: 16px;
      text-align: right;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.2s ease;
    }
    
    #dropdown button:hover {
      background: #f5f5f5;
    }
    
    #dropdown button i {
      font-size: 18px;
      width: 24px;
      text-align: center;
    }
    
    /* أكواد البرمجة المحسنة */
    pre {
      background: #2d2d2d;
      color: #f8f8f2;
      padding: 40px 15px 15px 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 14px;
      margin: 15px 0;
      position: relative;
      direction: ltr;
      text-align: left;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
    }
    
    .code-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: #1e1e1e;
      padding: 8px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
    }
    
    .language-tag {
      font-size: 12px;
      color: #aaa;
      text-transform: uppercase;
    }
    
    .copy-btn {
      background: #128c7e;
      border: none;
      color: white;
      border-radius: 4px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .copy-btn:hover {
      background: #075e54;
    }
    
    /* مؤشر الكتابة المتحرك */
    .typing-indicator {
      display: inline-flex;
      align-items: center;
      background: var(--bot-message);
      border: 1px solid var(--border-color);
      padding: 10px 20px;
      border-radius: 18px;
      border-bottom-left-radius: 0;
      box-shadow: var(--shadow);
    }
    
    .typing-indicator span {
      width: 8px;
      height: 8px;
      background-color: #999;
      border-radius: 50%;
      display: inline-block;
      margin: 0 2px;
      animation: typing 1s infinite;
    }
    
    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }
    
    /* تأثيرات متحركة */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .pulse {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    /* رسالة الترحيب */
    .welcome-message {
      text-align: center;
      max-width: 600px;
      margin: auto;
      padding: 30px;
      animation: fadeIn 0.5s ease;
    }
    
    .welcome-message h2 {
      font-size: 2rem;
      margin-bottom: 20px;
      color: var(--primary-dark);
    }
    
    .welcome-message p {
      font-size: 1.1rem;
      line-height: 1.6;
      margin-bottom: 25px;
      color: var(--text-secondary);
    }
    
    .features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    
    .feature {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .feature:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .feature i {
      font-size: 2.5rem;
      color: var(--primary-color);
      margin-bottom: 15px;
    }
    
    .feature h3 {
      margin-bottom: 10px;
      color: var(--primary-dark);
    }
    
    .feature p {
      font-size: 0.9rem;
    }
    
    /* نافذة الإعدادات */
    #settings-modal {
      display: none;
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .settings-content {
      background: white;
      width: 90%;
      max-width: 500px;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .settings-header h2 {
      font-size: 1.5rem;
      color: var(--primary-dark);
    }
    
    .close-settings {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-secondary);
      cursor: pointer;
    }
    
    .settings-body {
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 16px;
    }
    
    .settings-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background: var(--primary-color);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .btn-secondary {
      background: #f5f5f5;
      color: var(--text-primary);
    }
    
    .btn-secondary:hover {
      background: #e0e0e0;
    }
    
    /* معرض التعبيرات */
    #emoji-container {
      position: absolute;
      bottom: 70px;
      right: 60px;
      z-index: 100;
      display: none;
      background: white;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 15px;
      width: 300px;
      height: 250px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
    }
    
    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    
    .emoji-item {
      font-size: 1.5rem;
      cursor: pointer;
      text-align: center;
      padding: 5px;
      transition: all 0.2s ease;
      border-radius: 6px;
    }
    
    .emoji-item:hover {
      background: #f0f0f0;
      transform: scale(1.2);
    }
    
    /* التكيف مع الشاشات الصغيرة */
    @media (max-width: 768px) {
      #app {
        border-radius: 0;
      }
      
      header {
        padding: 0 15px;
      }
      
      .app-title h1 {
        font-size: 1.2rem;
      }
      
      .message {
        max-width: 90%;
      }
      
      .welcome-message {
        padding: 20px;
      }
      
      .features {
        grid-template-columns: 1fr;
      }
      
      #emoji-container {
        right: 10px;
        width: 280px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <div class="header-left">
        <div class="logo">
          <i class="fas fa-robot"></i>
        </div>
        <div class="app-title">
          <h1>مساعد الذكاء الاصطناعي</h1>
          <p>نسخة احترافية - متطور</p>
        </div>
      </div>
      <div class="header-actions">
        <button class="header-btn" title="فتح المحادثات" onclick="toggleSidebar()">
          <i class="fas fa-comments"></i>
        </button>
        <button class="header-btn" title="إعدادات" onclick="openSettings()">
          <i class="fas fa-cog"></i>
        </button>
      </div>
    </header>

    <aside id="sidebar">
      <div class="sidebar-header">
        <h2>المحادثات السابقة</h2>
        <button class="close-sidebar" onclick="toggleSidebar()">&times;</button>
      </div>
      <button id="new-chat-btn" onclick="startNewChat()">
        <i class="fas fa-plus"></i> محادثة جديدة
      </button>
      <ul id="chat-list"></ul>
    </aside>

    <main id="chat-window">
      <div class="welcome-message">
        <h2>مرحبًا بك في مساعد الذكاء الاصطناعي</h2>
        <p>هذا المساعد المتطور يمكنه الإجابة على أسئلتك، مساعدتك في كتابة الأكواد البرمجية، تحليل المستندات، والعديد من المهام الأخرى. ابدأ بالكتابة في الأسفل أو جرب أحد الخيارات المتاحة.</p>
        
        <div class="features">
          <div class="feature">
            <i class="fas fa-code"></i>
            <h3>برمجة متقدمة</h3>
            <p>مساعدة في كتابة وتصحيح الأكواد البرمجية</p>
          </div>
          <div class="feature">
            <i class="fas fa-file-alt"></i>
            <h3>تحليل المستندات</h3>
            <p>تحميل المستندات لتحليل محتواها</p>
          </div>
          <div class="feature">
            <i class="fas fa-language"></i>
            <h3>ترجمة فورية</h3>
            <p>ترجمة النصوص بين اللغات المختلفة</p>
          </div>
          <div class="feature">
            <i class="fas fa-brain"></i>
            <h3>ذكاء متطور</h3>
            <p>إجابات دقيقة على أسئلتك المعقدة</p>
          </div>
        </div>
      </div>
    </main>

    <div id="input-area">
      <div class="input-group">
        <input
          type="text"
          id="prompt"
          placeholder="اكتب رسالتك هنا..."
          onkeypress="if(event.key === 'Enter') sendMessage()"
        />
        <div class="input-actions">
          <button class="input-btn" title="معرض التعبيرات" onclick="toggleEmojiPicker()">
            <i class="far fa-smile"></i>
          </button>
          <button class="input-btn" title="رفع ملف" onclick="togglePlusMenu()">
            <i class="fas fa-paperclip"></i>
          </button>
        </div>
      </div>
      <button id="send-btn" class="input-btn" onclick="sendMessage()">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>

    <div id="dropdown">
      <button onclick="uploadFile('document')">
        <i class="fas fa-file-pdf"></i> رفع مستند PDF
      </button>
      <button onclick="uploadFile('image')">
        <i class="fas fa-image"></i> رفع صورة
      </button>
      <button onclick="uploadFile('audio')">
        <i class="fas fa-microphone"></i> تسجيل صوتي
      </button>
      <button onclick="uploadFile('spreadsheet')">
        <i class="fas fa-file-excel"></i> رفع جدول بيانات
      </button>
    </div>

    <!-- تعديل نافذة الإعدادات لتحتوي على "الملف الشخصي" --><div id="settings-modal">
  <div class="settings-content">
    <div class="settings-header">
      <h2>الإعدادات</h2>
      <button class="close-settings" onclick="closeSettings()">&times;</button>
    </div><div class="settings-body">
  <!-- قائمة تبويبات -->
  <div class="form-group">
    <button class="btn btn-secondary" onclick="showProfileSettings()">الملف الشخصي</button>
    <button class="btn btn-secondary" onclick="showApiSettings()">تغيير الـ API</button>
  </div>

  <!-- تبويب: الملف الشخصي -->
  <div id="profile-settings" style="display:none;">
    <div style="text-align:center; margin-bottom: 20px;">
      <div onclick="promptForImage()" style="width:100px;height:100px;border-radius:50%;background:#eee;overflow:hidden;margin:auto;position:relative;cursor:pointer">
        <img id="profile-image" src="" style="width:100%;height:100%;object-fit:cover;display:none">
        <span id="plus-icon" style="position:absolute;bottom:5px;left:5px;font-size:24px;color:#888;background:#fff;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;box-shadow:0 0 5px rgba(0,0,0,0.2)">+</span>
      </div>
    </div>
    <div class="form-group">
      <label>الاسم الكامل:</label>
      <input type="text" id="full-name" placeholder="ادخل اسمك الكامل">
    </div>
    <div class="form-group">
      <label>اسم المستخدم:</label>
      <input type="text" id="username" placeholder="ادخل اسم المستخدم">
    </div>
    <div class="form-group">
      <label>البريد الإلكتروني:</label>
      <input type="email" id="email" placeholder="ادخل بريدك الإلكتروني">
    </div>
  </div>

  <!-- تبويب: تغيير API -->
  <div id="api-settings" style="display:none;">
    <div class="form-group">
      <label for="api-key">مفتاح API:</label>
      <input type="password" id="api-key" placeholder="أدخل مفتاح API الخاص بك">
    </div>
  </div>
</div>

<div class="settings-footer">
  <button class="btn btn-secondary" onclick="closeSettings()">إلغاء</button>
  <button class="btn btn-primary" onclick="saveSettings()">حفظ</button>
</div>

  </div>
</div><script>
  function openSettings() {
    document.getElementById('settings-modal').style.display = 'flex';
    document.getElementById('api-key').value = apiKey;
    showProfileSettings();
  }

  function showProfileSettings() {
    document.getElementById('profile-settings').style.display = 'block';
    document.getElementById('api-settings').style.display = 'none';
  }

  function showApiSettings() {
    document.getElementById('profile-settings').style.display = 'none';
    document.getElementById('api-settings').style.display = 'block';
  }

  function promptForImage() {
    const url = prompt("أدخل رابط الصورة:");
    if (url) {
      const img = document.getElementById('profile-image');
      img.src = url;
      img.style.display = 'block';
      document.getElementById('plus-icon').style.display = 'none';
    }
  }

  function saveSettings() {
    localStorage.setItem("fullName", document.getElementById("full-name").value);
    localStorage.setItem("username", document.getElementById("username").value);
    localStorage.setItem("email", document.getElementById("email").value);
    localStorage.setItem("profileImage", document.getElementById("profile-image").src);
    apiKey = document.getElementById('api-key').value;
    localStorage.setItem('apiKey', apiKey);
    closeSettings();
    alert("تم حفظ الإعدادات بنجاح!");
  }

  function loadProfile() {
    document.getElementById("full-name").value = localStorage.getItem("fullName") || "";
    document.getElementById("username").value = localStorage.getItem("username") || "";
    document.getElementById("email").value = localStorage.getItem("email") || "";
    const img = localStorage.getItem("profileImage");
    if (img) {
      document.getElementById("profile-image").src = img;
      document.getElementById("profile-image").style.display = 'block';
      document.getElementById("plus-icon").style.display = 'none';
    }
  }

  document.addEventListener("DOMContentLoaded", loadProfile);
</script><!-- نسخ الشيفرة البرمجية والرسائل --><style>
  .code-header {
    position: absolute;
    top: 0;
    right: 0;
    padding: 5px 10px;
    z-index: 1;
  }

  .copy-btn {
    background: #128c7e;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 12px;
    padding: 4px 8px;
    cursor: pointer;
    transition: 0.2s;
  }

  .copy-btn:hover {
    background: #0e6e61;
  }

  .message {
    position: relative;
  }

  .message .message-copy-btn {
    position: absolute;
    top: 5px;
    left: 10px;
    background: none;
    border: none;
    color: #888;
    cursor: pointer;
    font-size: 16px;
    transition: color 0.3s;
  }

  .message .message-copy-btn:hover {
    color: #128c7e;
  }
</style><script>
  function copyCode(button) {
    const code = button.closest('.code-header').nextElementSibling.textContent;
    navigator.clipboard.writeText(code).then(() => {
      const originalText = button.innerHTML;
      button.innerHTML = 'تم النسخ!';
      setTimeout(() => {
        button.innerHTML = originalText;
      }, 2000);
    });
  }

  function copyMessage(button) {
    const msg = button.closest('.message').querySelector('.message-content').innerText;
    navigator.clipboard.writeText(msg).then(() => {
      const original = button.innerHTML;
      button.innerHTML = '<i class="fas fa-check"></i>';
      setTimeout(() => button.innerHTML = '<i class="fas fa-copy"></i>', 2000);
    });
  }
</script>
    <!-- معرض التعبيرات -->
    <div id="emoji-container">
      <div class="emoji-grid" id="emoji-grid"></div>
    </div>
  </div>

  <!-- مكتبة التمييز اللوني -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css"
  />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
  <script>
    let chats = [];
    let currentChatId = null;
    let apiKey = localStorage.getItem('apiKey') || "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";
    
    // دالة لإنشاء معرف عشوائي
    function generateId() {
      return Math.random().toString(36).substr(2, 9);
    }
    
    // دالة لتنسيق الوقت
    function formatTime(date = new Date()) {
      return date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
    }

    document.addEventListener("DOMContentLoaded", () => {
      <!-- startNewChat(); -->
      initEmojis();
      
      // إغلاق القوائم عند النقر خارجها
      document.addEventListener("click", function (event) {
        const sidebar = document.getElementById("sidebar");
        const dropdown = document.getElementById("dropdown");
        const settingsModal = document.getElementById("settings-modal");
        const emojiContainer = document.getElementById("emoji-container");
        const menuBtn = document.querySelector(".header-btn");
        const plusBtn = document.querySelector(".fa-paperclip").closest(".input-btn");
        const emojiBtn = document.querySelector(".fa-smile").closest(".input-btn");
        
        if (sidebar.classList.contains("visible") && 
            !sidebar.contains(event.target) && 
            !menuBtn.contains(event.target)) {
          sidebar.classList.remove("visible");
        }
        
        if (dropdown.style.display === "flex" && 
            !dropdown.contains(event.target) && 
            !plusBtn.contains(event.target)) {
          dropdown.style.display = "none";
        }
        
        if (settingsModal.style.display === "flex" && 
            event.target === settingsModal) {
          closeSettings();
        }
        
        if (emojiContainer.style.display === "block" && 
            !emojiContainer.contains(event.target) && 
            !emojiBtn.contains(event.target)) {
          emojiContainer.style.display = "none";
        }
      });
    });

    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      sidebar.classList.toggle("visible");
    }

    function togglePlusMenu() {
      const dropdown = document.getElementById("dropdown");
      dropdown.style.display = dropdown.style.display === "flex" ? "none" : "flex";
    }
    
    function toggleEmojiPicker() {
      const emojiContainer = document.getElementById("emoji-container");
      emojiContainer.style.display = emojiContainer.style.display === "block" ? "none" : "block";
    }
    
    // تهيئة معرض التعبيرات
    function initEmojis() {
      const emojis = [
        "😀", "😃", "😄", "😁", "😆", "😅", "😂", "🤣", "😊", "😇", 
        "🙂", "🙃", "😉", "😌", "😍", "🥰", "😘", "😗", "😙", "😚", 
        "😋", "😛", "😝", "😜", "🤪", "🤨", "🧐", "🤓", "😎", "🤩", 
        "🥳", "😏", "😒", "😞", "😔", "😟", "😕", "🙁", "☹️", "😣", 
        "😖", "😫", "😩", "🥺", "😢", "😭", "😤", "😠", "😡", "🤬", 
        "🤯", "😳", "🥵", "🥶", "😱", "😨", "😰", "😥", "😓", "🤗", 
        "🤔", "🤭", "🤫", "🤥", "😶", "😐", "😑", "😬", "🙄", "😯", 
        "😦", "😧", "😮", "😲", "🥱", "😴", "🤤", "😪", "😵", "🤐", 
        "🥴", "🤢", "🤮", "🤧", "😷", "🤒", "🤕", "🤑", "🤠", "😈", 
        "👿", "👹", "👺", "🤡", "💩", "👻", "💀", "☠️", "👽", "👾", 
        "🤖", "🎃", "😺", "😸", "😹", "😻", "😼", "😽", "🙀", "😿", 
        "😾", "👋", "🤚", "🖐", "✋", "🖖", "👌", "🤏", "✌️", "🤞", 
        "🤟", "🤘", "🤙", "👈", "👉", "👆", "🖕", "👇", "☝️", "👍", 
        "👎", "✊", "👊", "🤛", "🤜", "👏", "🙌", "👐", "🤲", "🤝", 
        "🙏", "✍️", "💅", "🤳", "💪", "🦾", "🦿", "🦵", "🦶", "👂", 
        "🦻", "👃", "🧠", "🦷", "🦴", "👀", "👁", "👅", "👄", "💋", 
        "🩸", "💘", "❤️", "💓", "💔", "💕", "💖", "💗", "💙", "💚", 
        "💛", "💜", "🖤", "💝", "💞", "💟", "❣️", "💌", "💤", "💢", 
        "💣", "💥", "💦", "💨", "💫", "💬", "👁️‍🗨️", "🗨️", "🗯️", "💭", 
        "🕳️", "👓", "🕶️", "🥽", "🥼", "🦺", "👔", "👕", "👖", "🧣", 
        "🧤", "🧥", "🧦", "👗", "👘", "🥻", "🩱", "🩲", "🩳", "👙", 
        "👚", "👛", "👜", "👝", "🎒", "👞", "👟", "🥾", "🥿", "👠", 
        "👡", "🩰", "👢", "👑", "👒", "🎩", "🎓", "🧢", "⛑️", "💄", 
        "💍", "💼"
      ];
      
      const emojiGrid = document.getElementById("emoji-grid");
      emojis.forEach(emoji => {
        const emojiItem = document.createElement("div");
        emojiItem.className = "emoji-item";
        emojiItem.textContent = emoji;
        emojiItem.onclick = () => {
          document.getElementById("prompt").value += emoji;
          document.getElementById("emoji-container").style.display = "none";
        };
        emojiGrid.appendChild(emojiItem);
      });
    }
    
    function openSettings() {
      document.getElementById('settings-modal').style.display = 'flex';
      document.getElementById('api-key').value = apiKey;
    }
    
    function closeSettings() {
      document.getElementById('settings-modal').style.display = 'none';
    }
    
    function saveApiKey() {
      apiKey = document.getElementById('api-key').value;
      localStorage.setItem('apiKey', apiKey);
      closeSettings();
      alert('تم حفظ مفتاح API بنجاح!');
    }

    function startNewChat() {
      const chatId = generateId();
      chats.push({ id: chatId, messages: [], title: "محادثة جديدة" });
      currentChatId = chatId;
      updateChatList();
      renderMessages();
      
      // الحل: التحقق من وجود العنصر قبل تعديله
      const welcomeMessage = document.querySelector('.welcome-message');
      if (welcomeMessage) {
        welcomeMessage.style.display = 'none';
      }
    }

    function updateChatList() {
      const list = document.getElementById("chat-list");
      list.innerHTML = "";
      
      chats.slice().reverse().forEach((chat) => {
        const li = document.createElement("li");
        li.innerHTML = `
          <div class="chat-info">
            <i class="fas fa-comment chat-icon"></i>
            <span>${chat.title}</span>
          </div>
          <button class="delete-chat" title="حذف المحادثة" onclick="deleteChat('${chat.id}')">
            <i class="fas fa-trash"></i>
          </button>
        `;
        li.className = currentChatId === chat.id ? "active" : "";
        li.onclick = (e) => {
          // تجنب تنفيذ الحذف عند النقر على زر الحذف
          if (!e.target.closest('.delete-chat')) {
            currentChatId = chat.id;
            renderMessages();
            toggleSidebar();
            
            // الحل: التحقق من وجود العنصر قبل تعديله
            const welcomeMessage = document.querySelector('.welcome-message');
            if (welcomeMessage) {
              welcomeMessage.style.display = 'none';
            }
          }
        };
        list.appendChild(li);
      });
    }
    function deleteChat(chatId) {
      if (confirm('هل أنت متأكد من حذف هذه المحادثة؟')) {
        chats = chats.filter(chat => chat.id !== chatId);
        
        // إذا كانت المحادثة المحذوفة هي الحالية، نبدأ محادثة جديدة
        if (currentChatId === chatId) {
          if (chats.length > 0) {
            currentChatId = chats[chats.length - 1].id;
          } else {
            startNewChat();
          }
        }
        
        updateChatList();
        renderMessages();
      }
    }

    function renderMessages() {
      const chatWindow = document.getElementById("chat-window");
      
      // إظهار رسالة الترحيب إذا لم تكن هناك رسائل
      const chat = chats.find((c) => c.id === currentChatId);
      if (!chat || chat.messages.length === 0) {
        chatWindow.innerHTML = `
          <div class="welcome-message">
            <h2>مرحبًا بك في مساعد الذكاء الاصطناعي</h2>
            <p>هذا المساعد المتطور يمكنه الإجابة على أسئلتك، مساعدتك في كتابة الأكواد البرمجية، تحليل المستندات، والعديد من المهام الأخرى. ابدأ بالكتابة في الأسفل أو جرب أحد الخيارات المتاحة.</p>
            
            <div class="features">
              <div class="feature">
                <i class="fas fa-code"></i>
                <h3>برمجة متقدمة</h3>
                <p>مساعدة في كتابة وتصحيح الأكواد البرمجية</p>
              </div>
              <div class="feature">
                <i class="fas fa-file-alt"></i>
                <h3>تحليل المستندات</h3>
                <p>تحميل المستندات لتحليل محتواها</p>
              </div>
              <div class="feature">
                <i class="fas fa-language"></i>
                <h3>ترجمة فورية</h3>
                <p>ترجمة النصوص بين اللغات المختلفة</p>
              </div>
              <div class="feature">
                <i class="fas fa-brain"></i>
                <h3>ذكاء متطور</h3>
                <p>إجابات دقيقة على أسئلتك المعقدة</p>
              </div>
            </div>
          </div>
        `;
        return;
      }

      chatWindow.innerHTML = "";
      
      chat.messages.forEach((msg) => {
        const div = document.createElement("div");
        div.className = `message ${msg.role}`;
        
        if (msg.role === 'assistant' && msg.content === "جارٍ الكتابة...") {
          div.className = "message bot";
          div.innerHTML = `
            <div class="typing-indicator">
              <span></span>
              <span></span>
              <span></span>
            </div>
          `;
        } else {
          div.innerHTML = `
            <div class="message-header">
              <div class="message-sender">
                ${msg.role === 'user' ? 'أنت' : 'Taiz Soft'}
              </div>
              <div class="message-time">${formatTime(msg.timestamp)}</div>
            </div>
            <div class="message-content">
              ${formatMessageContent(msg.content)}
            </div>
          `;
        }
        
        chatWindow.appendChild(div);
      });

      // تمرير الشاشة لأسفل لعرض آخر رسالة
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    
    function formatMessageContent(content) {
      // معالجة الأكواد البرمجية
      if (/```[\s\S]*?```/.test(content)) {
        const codeBlocks = content.match(/```(\w*)\n([\s\S]*?)```/g);
        let formattedContent = content;
        
        codeBlocks.forEach((block) => {
          const langMatch = block.match(/```(\w*)\n/);
          const lang = langMatch ? langMatch[1] : 'text';
          const codeText = block.replace(/```(\w*)\n/, '').replace(/```$/, '');
          
          const codeBlock = `
            <div style="position: relative; margin: 15px 0;">
              <div class="code-header">
                <span class="language-tag">${lang}</span>
                <button class="copy-btn" onclick="copyCode(this)">
                  <i class="fas fa-copy"></i> نسخ الكود
                </button>
              </div>
              <pre><code class="language-${lang}">${escapeHtml(codeText)}</code></pre>
            </div>
          `;
          
          formattedContent = formattedContent.replace(block, codeBlock);
        });
        
        return formattedContent;
      }
      
      return content.replace(/\n/g, '<br>');
    }
    
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    
    function copyCode(button) {
      const code = button.closest('.code-header').nextElementSibling.textContent;
      navigator.clipboard.writeText(code).then(() => {
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> تم النسخ!';
        setTimeout(() => {
          button.innerHTML = originalText;
        }, 2000);
      });
    }

    async function sendMessage(customPrompt = null) {
      const input = document.getElementById("prompt");
      const prompt = customPrompt || input.value.trim();
      if (!prompt) return;
      input.value = "";

      if (!currentChatId) {
  startNewChat(); // ← إنشاء محادثة جديدة عند أول رسالة
}
const chat = chats.find((c) => c.id === currentChatId);
      chat.messages.push({ 
        role: "user", 
        content: prompt,
        timestamp: new Date()
      });
      renderMessages();

      const typingMsg = { 
        role: "assistant", 
        content: "جارٍ الكتابة...",
        timestamp: new Date()
      };
      chat.messages.push(typingMsg);
      renderMessages();

      try {
        const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${apiKey}`,
            "HTTP-Referer": "https://example.com",
            "X-Title": "AI-Test",
          },
          body: JSON.stringify({
            model: "openai/gpt-4o",
            messages: chat.messages
              .filter(m => m.role !== 'assistant' || m.content !== "جارٍ الكتابة...")
              .map(({role, content}) => ({ role, content })),
            max_tokens: 500,
          }),
        });

        const data = await res.json();
        const content = data.choices?.[0]?.message?.content || "لم أتمكن من إيجاد رد مناسب.";

        chat.messages.pop(); // إزالة "جارٍ الكتابة..."
        chat.messages.push({ 
          role: "assistant", 
          content,
          timestamp: new Date()
        });

        if (chat.title === "محادثة جديدة") {
          chat.title = content.slice(0, 30) + (content.length > 30 ? "..." : "");
          updateChatList();
        }

        renderMessages();
      } catch (err) {
        console.error(err);
        chat.messages.pop();
        chat.messages.push({ 
          role: "assistant", 
          content: "⚠️ حدث خطأ أثناء محاولة الاتصال. يرجى المحاولة مرة أخرى.",
          timestamp: new Date()
        });
        renderMessages();
        
        }
    }
    
    function uploadFile(type) {
      togglePlusMenu();
      
      let message;
      switch (type) {
        case 'document':
          message = "تم رفع المستند بنجاح. كيف يمكنني مساعدتك في تحليله؟";
          break;
        case 'image':
          message = "تم رفع الصورة بنجاح. كيف يمكنني مساعدتك في وصفها أو تحليلها؟";
          break;
        case 'audio':
          message = "تم رفع التسجيل الصوتي بنجاح. كيف يمكنني مساعدتك في تحويله إلى نص أو تحليله؟";
          break;
        case 'spreadsheet':
          message = "تم رفع جدول البيانات بنجاح. كيف يمكنني مساعدتك في تحليل البيانات؟";
          break;
        default:
          message = "تم رفع الملف بنجاح. كيف يمكنني مساعدتك؟";
      }
      
      const chat = chats.find((c) => c.id === currentChatId);
      chat.messages.push({ 
        role: "user", 
        content: `[تم رفع ملف من نوع ${type}]`,
        timestamp: new Date()
      });
      chat.messages.push({ 
        role: "assistant", 
        content: message,
        timestamp: new Date()
      });
      
      renderMessages();
    }
  </script>
  
  <script>
    // تفعيل التمييز اللوني للغات في الأكواد
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
      });
    });
  </script>
</body>
</html>